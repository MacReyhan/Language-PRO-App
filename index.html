<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Pro - Authenticated Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS Variables for Theming */
        :root, body[data-theme="light"] {
            --bg-color: #f4f7fa;
            --card-bg: #ffffff;
            --primary-color: #3b82f6; /* Blue 500 */
            --primary-hover: #2563eb; /* Blue 600 */
            --text-color: #1f2937; /* Gray 800 */
            --subtle-text: #6b7280; /* Gray 500 */
            --input-bg: #f9fafb;
            --action-1: #3b82f6; /* Blue */
            --action-2: #4f46e5; /* Indigo */
            --action-3: #14b8a6; /* Teal */
        }
        body[data-theme="dark"] {
            --bg-color: #1f2937; /* Dark Gray */
            --card-bg: #374151; /* Medium Dark Gray */
            --primary-color: #60a5fa; /* Blue 400 */
            --primary-hover: #3b82f6; /* Blue 500 */
            --text-color: #f3f4f6; /* Light Gray */
            --subtle-text: #9ca3af; /* Gray 400 */
            --input-bg: #4b5563;
            --action-1: #60a5fa; 
            --action-2: #818cf8; 
            --action-3: #2dd4bf;
        }
        body[data-theme="dark-purple"] {
            --bg-color: #240a35; /* Deep Purple */
            --card-bg: #3a155c;
            --primary-color: #c4b5fd; /* Lavender */
            --primary-hover: #a78bfa;
            --text-color: #f3e8ff;
            --subtle-text: #d8b4fe;
            --input-bg: #4c267a;
            --action-1: #a78bfa; 
            --action-2: #d8b4fe; 
            --action-3: #f5d0fe;
        }
        body[data-theme="blue"] {
            --bg-color: #e0f2fe; /* Light Blue */
            --card-bg: #ffffff;
            --primary-color: #0369a1; /* Sky Blue */
            --primary-hover: #075985;
            --text-color: #0c4a6e;
            --subtle-text: #38bdf8;
            --input-bg: #f0f9ff;
            --action-1: #38bdf8;
            --action-2: #0ea5e9;
            --action-3: #0369a1;
        }
        body[data-theme="sea-green"] {
            --bg-color: #ecfdf5; /* Mint Green */
            --card-bg: #ffffff;
            --primary-color: #059669; /* Emerald */
            --primary-hover: #047857;
            --text-color: #064e3b;
            --subtle-text: #34d399;
            --input-bg: #f0fff4;
            --action-1: #10b981;
            --action-2: #059669;
            --action-3: #34d399;
        }
        body[data-theme="pink"] {
            --bg-color: #fdf2f8; /* Pale Pink */
            --card-bg: #ffffff;
            --primary-color: #ec4899; /* Pink */
            --primary-hover: #db2777;
            --text-color: #831843;
            --subtle-text: #f472b6;
            --input-bg: #fff1f2;
            --action-1: #f472b6;
            --action-2: #ec4899;
            --action-3: #db2777;
        }

        /* Applying Variables */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container-card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            background-color: var(--card-bg);
            transition: all 0.3s ease-in-out;
            /* FIX: Forced height so modal can fill it */
            height: 80vh; 
            min-height: 500px;
        }
        .text-primary { color: var(--primary-color); }
        .bg-primary { background-color: var(--primary-color); }
        .hover-bg-primary:hover { background-color: var(--primary-hover); }
        .border-primary { border-color: var(--primary-color); }
        
        .action-button-1 { background-color: var(--action-1); }
        .action-button-2 { background-color: var(--action-2); }
        .action-button-3 { background-color: var(--action-3); }

        .action-button {
            transition: all 0.2s;
            transform: scale(1);
        }
        .action-button:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .action-button:active {
            transform: scale(0.98);
        }
        .voice-icon {
            opacity: 0.6;
            transition: opacity 0.2s, color 0.3s;
        }
        .voice-icon:hover {
            opacity: 1;
        }
        
        textarea, input[type="text"], input[type="email"], input[type="password"], input[type="tel"], input[type="number"] {
            background-color: var(--input-bg) !important;
            border-color: var(--subtle-text);
            color: var(--text-color) !important;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        /* Auth/App View Transition */
        .auth-view, .app-view, #settings-modal {
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }
        .hidden-transition {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
            display: block; 
        }
        .visible-transition {
            opacity: 1;
            transform: translateY(0);
        }

        /* FIX: Settings Modal Sizing and Scroll */
        #settings-modal {
            /* Make it fill the entire main card */
            width: 100%;
            height: 100%; /* Now guaranteed to fill the 80vh parent */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            /* Ensure smooth scrolling within the modal */
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center" data-theme="light">

    <div id="main-container" class="w-full max-w-4xl container-card rounded-xl p-6 md:p-10 relative">

        <!-- Loading View -->
        <div id="loading-view" class="flex flex-col items-center justify-center p-12 text-gray-500">
             <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 font-semibold text-subtle-text">Checking your credentials, hold up...</p>
        </div>
        
        <!-- Authentication View (Sign In/Sign Up) -->
        <div id="auth-view" class="auth-view hidden-transition">
            
            <h1 class="text-3xl font-extrabold text-primary mb-2 text-center">Language Pro Access üîë</h1>
            <p class="text-subtle-text mb-8 text-center" id="auth-title-text">Sign In to continue, bro, or check out the Guest Mode.</p>

            <!-- Auth Mode Toggles -->
            <div class="flex justify-center mb-6 space-x-4">
                <button id="mode-email-btn" class="font-semibold text-primary border-b-2 border-primary pb-1 transition duration-150">Email / Password</button>
                <button id="mode-phone-btn" class="text-subtle-text border-b-2 border-transparent hover:text-primary hover:border-primary pb-1 transition duration-150">Phone / OTP</button>
            </div>

            <!-- Email/Password Container -->
            <div id="email-auth-container" class="max-w-md mx-auto">
                <form id="email-auth-form" class="space-y-6">
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-text-color">Email Address</label>
                        <input type="email" id="auth-email" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-text-color">Password</label>
                        <input type="password" id="auth-password" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>

                    <button type="submit" id="auth-submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover-bg-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Sign In
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <button id="toggle-auth-btn" class="text-sm font-medium text-primary hover:text-primary transition duration-150 ease-in-out">
                        Don't have an account? Sign Up
                    </button>
                </div>
            </div>

            <!-- Phone/OTP Container -->
            <div id="phone-auth-container" class="max-w-md mx-auto hidden">
                <form id="phone-auth-form" class="space-y-6">
                    <div>
                        <label for="phone-number" class="block text-sm font-medium text-text-color">Phone Number (with country code, e.g., +919876543210)</label>
                        <input type="tel" id="phone-number" required placeholder="+91..." class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>
                    
                    <!-- OTP Input (Hidden initially) -->
                    <div id="otp-input-group" class="hidden">
                        <label for="auth-otp" class="block text-sm font-medium text-text-color">Verification Code (OTP)</label>
                        <input type="number" id="auth-otp" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    </div>

                    <button type="submit" id="phone-submit-btn" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover-bg-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Request OTP
                    </button>
                </form>

                <!-- ReCAPTCHA Container (invisible or visible, depending on Firebase needs) -->
                <div id="recaptcha-container" class="mt-6"></div>
            </div>

            <!-- Guest Login -->
            <div class="mt-6 text-center border-t border-gray-200 pt-6">
                <button id="guest-login-btn" class="text-sm font-medium text-subtle-text hover:text-primary transition duration-150 ease-in-out p-2 border border-gray-300 rounded-md hover:border-primary">
                    Continue as Guest (Grammar Check Only)
                </button>
            </div>


            <!-- Auth Error Box -->
            <div id="auth-error-box" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden" role="alert">
                <p id="auth-error-message" class="font-medium text-sm"></p>
            </div>
        </div>

        <!-- Main Application View (After Login) -->
        <div id="app-view" class="app-view hidden-transition">
            <header class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-text-color">Language Pro üí¨</h1>
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium text-subtle-text hidden md:inline">Logged in as: <span id="user-display" class="font-semibold text-text-color"></span></span>
                    
                    <!-- Settings Button -->
                    <button id="settings-btn" class="p-2 rounded-full text-subtle-text hover:text-primary transition duration-150" title="Account Settings">
                         <!-- Settings Icon -->
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2H2a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h2v-.44a2 2 0 0 0-2-2h-.44a2 2 0 0 1-2-2v-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 1-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 1-2-2h-.44A2 2 0 0 0 12.22 2z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                    
                    <!-- Sign Out Button -->
                    <button id="sign-out-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg text-sm hover:bg-red-600 focus:outline-none focus:ring-4 focus:ring-red-300 transition duration-150">
                        Sign Out
                    </button>
                </div>
            </header>
            <p class="text-subtle-text mb-8">Hey, what's up? Drop your text below and let's polish it up!</p>

            <!-- Loading Spinner and Status -->
            <div id="status-message" class="mb-4 text-center text-sm font-medium text-primary hidden">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Processing...
            </div>

            <!-- Input Area -->
            <div class="mb-6 relative">
                <label for="input-text" class="block text-sm font-semibold text-text-color mb-2">Your Input</label>
                <textarea id="input-text" rows="6" class="w-full p-4 border rounded-lg focus:ring-primary focus:border-primary resize-none" placeholder="Type or speak your text here..."></textarea>
                
                <!-- Voice Input Button -->
                <button id="voice-input-btn" class="absolute bottom-4 right-4 p-2 text-primary voice-icon" title="Voice Input">
                    <!-- Microphone Icon (Lucide icon equivalent) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    <div id="recording-indicator" class="absolute top-0 right-0 h-3 w-3 rounded-full bg-red-500 hidden animate-ping"></div>
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <button id="grammar-check-btn" class="action-button action-button-1 flex-1 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Grammar Check (Enter)
                </button>
                <button id="paraphrase-btn" class="action-button action-button-2 flex-1 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    Paraphrase
                </button>
                <button id="hinglish-btn" class="action-button action-button-3 flex-1 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-4 focus:ring-teal-300">
                    Translate to Hinglish
                </button>
            </div>

            <!-- Output Area -->
            <div>
                <label for="output-text" class="block text-sm font-semibold text-text-color mb-2">Result</label>
                <textarea id="output-text" rows="6" class="w-full p-4 border rounded-lg resize-none" placeholder="Your transformed text will appear here..." readonly></textarea>
            </div>
            
            <!-- App Error/Modal Area -->
            <div id="error-box" class="mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden" role="alert">
                <p id="error-message" class="font-medium"></p>
                <p id="error-detail" class="text-sm mt-1"></p>
            </div>

        </div>

        <!-- Settings Modal (Absolute positioned for overlay effect) -->
        <div id="settings-modal" class="absolute inset-0 bg-card-bg rounded-xl p-6 md:p-10 hidden-transition overflow-y-auto">
            <h2 class="text-3xl font-bold text-primary mb-6">Account Settings ‚öôÔ∏è</h2>
            
            <!-- Close Button -->
            <button id="close-settings-btn" class="absolute top-4 right-4 p-2 text-subtle-text hover:text-red-500 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>

            <!-- Settings Success/Error Box -->
            <div id="settings-message-box" class="p-3 mb-4 rounded-lg hidden" role="alert">
                <p id="settings-message-text" class="font-medium text-sm"></p>
            </div>

            <!-- Theme Settings -->
            <section class="mb-8 border-b pb-6 border-gray-200">
                <h3 class="text-xl font-semibold text-text-color mb-3">Theme & Look</h3>
                <p class="text-subtle-text mb-3">Choose your vibe, dude. Custom colors for that pro feeling.</p>
                <div id="theme-options" class="flex flex-wrap gap-3">
                    <button data-theme="light" class="theme-btn border border-gray-300 p-2 rounded-lg text-sm transition duration-150">Light</button>
                    <button data-theme="dark" class="theme-btn border border-gray-300 p-2 rounded-lg text-sm transition duration-150">Dark</button>
                    <button data-theme="dark-purple" class="theme-btn border border-gray-300 p-2 rounded-lg text-sm transition duration-150">Dark Purple</button>
                    <button data-theme="blue" class="theme-btn border border-gray-300 p-2 rounded-lg text-sm transition duration-150">Blue</button>
                    <button data-theme="sea-green" class="theme-btn border border-gray-300 p-2 rounded-lg text-sm transition duration-150">Sea Green</button>
                    <button data-theme="pink" class="theme-btn border border-gray-300 p-2 rounded-lg text-sm transition duration-150">Pink</button>
                </div>
            </section>
            
            <!-- Profile Details -->
            <section class="mb-8 border-b pb-6 border-gray-200">
                <h3 class="text-xl font-semibold text-text-color mb-3">Profile Details</h3>
                <form id="update-profile-form" class="space-y-4 max-w-md">
                    <div>
                        <label for="profile-name" class="block text-sm font-medium text-text-color">Display Name</label>
                        <input type="text" id="profile-name" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:ring-primary focus:border-primary">
                    </div>
                    <button type="submit" id="update-profile-btn" class="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover-bg-primary transition duration-150">
                        Update Name
                    </button>
                </form>
            </section>

            <!-- Change Email -->
            <section class="mb-8 border-b pb-6 border-gray-200">
                <h3 class="text-xl font-semibold text-text-color mb-3">Change Email</h3>
                <form id="update-email-form" class="space-y-4 max-w-md">
                    <div>
                        <label for="new-email" class="block text-sm font-medium text-text-color">New Email Address</label>
                        <input type="email" id="new-email" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:ring-primary focus:border-primary">
                    </div>
                    <div class="pt-2 border-t border-gray-300">
                         <label for="current-password-email" class="block text-sm font-medium text-text-color">Current Password (Security Check)</label>
                        <input type="password" id="current-password-email" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:ring-primary focus:border-primary">
                    </div>
                    <button type="submit" id="update-email-btn" class="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover-bg-primary transition duration-150">
                        Update Email
                    </button>
                </form>
            </section>
            
            <!-- Change Password -->
            <section class="mb-8 border-b pb-6 border-gray-200">
                <h3 class="text-xl font-semibold text-text-color mb-3">Change Password</h3>
                <form id="update-password-form" class="space-y-4 max-w-md">
                    <div>
                        <label for="new-password" class="block text-sm font-medium text-text-color">New Password (min 6 chars)</label>
                        <input type="password" id="new-password" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:ring-primary focus:border-primary">
                    </div>
                    <div class="pt-2 border-t border-gray-300">
                         <label for="current-password-pass" class="block text-sm font-medium text-text-color">Current Password (Security Check)</label>
                        <input type="password" id="current-password-pass" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:ring-primary focus:border-primary">
                    </div>
                    <button type="submit" id="update-password-btn" class="bg-primary text-white font-semibold py-2 px-4 rounded-lg hover-bg-primary transition duration-150">
                        Update Password
                    </button>
                </form>
            </section>

            <!-- Danger Zone -->
            <section>
                <h3 class="text-xl font-semibold text-red-600 mb-3">Danger Zone üíÄ</h3>
                <p class="text-subtle-text mb-4">Warning: Deleting your account is permanent and cannot be undone.</p>
                <form id="delete-account-form" class="space-y-4 max-w-md p-4 border border-red-300 rounded-lg bg-red-50">
                    <div>
                        <label for="delete-password" class="block text-sm font-medium text-red-700">Confirm Password to Delete Account</label>
                        <input type="password" id="delete-password" required class="mt-1 block w-full px-3 py-2 border border-red-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                    </div>
                    <button type="submit" id="delete-account-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-150">
                        Permanently Delete Account
                    </button>
                </form>
            </section>

        </div>
    </div>

    <!-- Firebase and API Call Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPhoneNumber, RecaptchaVerifier, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, updateEmail, updatePassword, deleteUser, reauthenticateWithCredential, EmailAuthProvider, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore logging for debugging
        setLogLevel('debug');

        // ----------------------------------------------------------------------
        // üõë CRITICAL STEP: YOUR HARDCODED FIREBASE CONFIG üõë
        // ----------------------------------------------------------------------
        
        // 1. Set the App ID to your new Firebase Project ID
        const appId = "language-pro-f55ea"; 
        
        // 2. YOUR FULL firebaseConfig OBJECT
        const firebaseConfig = {
            apiKey: "AIzaSyBpTa0-Xs4owjDg24y9stHEae8FvkZ8cns",
            authDomain: "language-pro-f55ea.firebaseapp.com",
            projectId: "language-pro-f55ea",
            storageBucket: "language-pro-f55ea.firebasestorage.app",
            messagingSenderId: "105582917502",
            appId: "1:105582917502:web:1286de0cfc13d01624252f",
            measurementId: "G-LK87B80R0T" 
        };
        
        // We set the initialAuthToken to null as it's not provided by GitHub Pages
        const initialAuthToken = null; 
        
        // ----------------------------------------------------------------------
        // END OF CONFIG REPLACEMENT SECTION
        // ----------------------------------------------------------------------
        
        let db;
        let auth;
        let userId = 'anonymous';
        let isGuest = false;

        // --- DOM ELEMENTS ---
        const loadingView = document.getElementById('loading-view');
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const settingsModal = document.getElementById('settings-modal');

        // Auth Mode Toggles
        const modeEmailBtn = document.getElementById('mode-email-btn');
        const modePhoneBtn = document.getElementById('mode-phone-btn');
        const emailAuthContainer = document.getElementById('email-auth-container');
        const phoneAuthContainer = document.getElementById('phone-auth-container');

        // Email Auth elements
        const emailAuthForm = document.getElementById('email-auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const toggleAuthBtn = document.getElementById('toggle-auth-btn');
        const authTitleText = document.getElementById('auth-title-text');

        // Phone Auth elements
        const phoneAuthForm = document.getElementById('phone-auth-form');
        const phoneNumberInput = document.getElementById('phone-number');
        const otpInputGroup = document.getElementById('otp-input-group');
        const authOtpInput = document.getElementById('auth-otp');
        const phoneSubmitBtn = document.getElementById('phone-submit-btn');
        const guestLoginBtn = document.getElementById('guest-login-btn');

        // Shared Auth elements
        const authErrorBox = document.getElementById('auth-error-box');
        const authErrorMessage = document.getElementById('auth-error-message');
        
        // App elements
        const userDisplay = document.getElementById('user-display');
        const signOutBtn = document.getElementById('sign-out-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const inputTextarea = document.getElementById('input-text');
        const outputTextarea = document.getElementById('output-text');
        const statusMessage = document.getElementById('status-message');
        const grammarBtn = document.getElementById('grammar-check-btn');
        const paraphraseBtn = document.getElementById('paraphrase-btn');
        const hinglishBtn = document.getElementById('hinglish-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const recordingIndicator = document.getElementById('recording-indicator');
        const errorBox = document.getElementById('error-box');
        const errorMessage = document.getElementById('error-message');
        const errorDetail = document.getElementById('error-detail');

        // Settings elements
        const themeOptionsContainer = document.getElementById('theme-options');
        const settingsMessageBox = document.getElementById('settings-message-box');
        const settingsMessageText = document.getElementById('settings-message-text');
        
        const updateProfileForm = document.getElementById('update-profile-form');
        const profileNameInput = document.getElementById('profile-name');
        
        const updateEmailForm = document.getElementById('update-email-form');
        const newEmailInput = document.getElementById('new-email');
        const currentPasswordEmailInput = document.getElementById('current-password-email');

        const updatePasswordForm = document.getElementById('update-password-form');
        const newPasswordInput = document.getElementById('new-password');
        const currentPasswordPassInput = document.getElementById('current-password-pass');

        const deleteAccountForm = document.getElementById('delete-account-form');
        const deletePasswordInput = document.getElementById('delete-password');
        
        // Initial Content
        const input_text = "Hey there, I need your help with a text I wrote for a new customer service bot we're launching. It needs to sound professional but chill, you know?";
        inputTextarea.value = input_text;
        
        // Auth State Management
        let isSigningUp = false;
        let authMode = 'email'; // 'email' or 'phone'
        let recaptchaVerifier;
        let verificationId = null; // Stores the confirmation result for OTP verification

        // --- UTILITY FUNCTIONS ---
        function setView(viewId) {
            loadingView.classList.add('hidden');
            authView.classList.add('hidden-transition');
            appView.classList.add('hidden-transition');
            settingsModal.classList.add('hidden-transition');

            if (viewId === 'auth') {
                authView.classList.remove('hidden-transition');
                authView.classList.add('visible-transition');
                setTimeout(() => {
                     authView.classList.remove('hidden');
                     appView.classList.add('hidden');
                     settingsModal.classList.add('hidden');
                }, 10); 
            } else if (viewId === 'app') {
                appView.classList.remove('hidden-transition');
                appView.classList.add('visible-transition');
                setTimeout(() => {
                    appView.classList.remove('hidden');
                    authView.classList.add('hidden');
                    settingsModal.classList.add('hidden');
                }, 10);
            } else if (viewId === 'settings') {
                settingsModal.classList.remove('hidden-transition');
                settingsModal.classList.add('visible-transition');
                setTimeout(() => {
                    settingsModal.classList.remove('hidden');
                    appView.classList.add('hidden');
                    authView.classList.add('hidden');
                }, 10);
                loadProfileDetails();
            } else {
                loadingView.classList.remove('hidden');
                authView.classList.add('hidden');
                appView.classList.add('hidden');
                settingsModal.classList.add('hidden');
            }
            hideAuthError();
            hideSettingsMessage();
        }

        function setGuestMode(enabled) {
            isGuest = enabled;
            const actionButtons = [paraphraseBtn, hinglishBtn, settingsBtn, signOutBtn];

            actionButtons.forEach(btn => {
                if (enabled) {
                    btn.disabled = true;
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.disabled = false;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });

            // Grammar Check is always available
            grammarBtn.disabled = false;
            grammarBtn.classList.remove('opacity-50', 'cursor-not-allowed');

            userDisplay.textContent = enabled ? 'Guest (Grammar Check Only)' : auth.currentUser?.displayName || auth.currentUser?.email || auth.currentUser?.phoneNumber || 'Authenticated User';
            
            // Only show Sign Out button if not a guest
            signOutBtn.classList.toggle('hidden', enabled);
            settingsBtn.classList.toggle('hidden', enabled);
        }
        
        function setProfileDisplay() {
            if (isGuest) return;
            const user = auth.currentUser;
            const displayName = user.displayName || 'Friend';
            userDisplay.textContent = displayName;
            profileNameInput.value = displayName;
            newEmailInput.placeholder = user.email || user.phoneNumber || 'N/A';
        }

        function showAuthError(message) {
            authErrorMessage.textContent = message;
            authErrorBox.classList.remove('hidden');
        }

        function hideAuthError() {
            authErrorBox.classList.add('hidden');
            authErrorMessage.textContent = '';
        }

        function showStatus(text) {
            statusMessage.textContent = text;
            statusMessage.classList.remove('hidden');
        }

        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        function showError(title, detail = '') {
            errorMessage.textContent = title;
            errorDetail.textContent = detail;
            errorBox.classList.remove('hidden');
        }

        function hideError() {
            errorBox.classList.add('hidden');
        }
        
        function showSettingsMessage(message, isSuccess = true) {
            settingsMessageText.textContent = message;
            settingsMessageBox.classList.remove('hidden');
            if (isSuccess) {
                settingsMessageBox.className = 'p-3 mb-4 rounded-lg bg-green-100 border border-green-400 text-green-700';
            } else {
                settingsMessageBox.className = 'p-3 mb-4 rounded-lg bg-red-100 border border-red-400 text-red-700';
            }
        }

        function hideSettingsMessage() {
            settingsMessageBox.classList.add('hidden');
        }
        
        // --- THEME LOGIC ---
        function setTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('app-theme', theme);
            
            // Highlight selected theme button
            document.querySelectorAll('.theme-btn').forEach(btn => {
                if (btn.getAttribute('data-theme') === theme) {
                    btn.classList.add('border-primary', 'bg-primary', 'text-white');
                    btn.classList.remove('border-gray-300');
                } else {
                    btn.classList.remove('border-primary', 'bg-primary', 'text-white');
                    btn.classList.add('border-gray-300');
                }
            });
        }

        // Apply theme from localStorage on load
        const storedTheme = localStorage.getItem('app-theme') || 'light';
        setTheme(storedTheme); 
        
        themeOptionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('theme-btn')) {
                setTheme(e.target.getAttribute('data-theme'));
            }
        });

        // --- FIREBASE INITIALIZATION AND AUTH ---
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Initialize RecaptchaVerifier on load/startup
            recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                'size': 'invisible', 
                'callback': (response) => {
                    console.log("reCAPTCHA solved, ready for OTP request.");
                },
                'expired-callback': () => {
                    console.error("reCAPTCHA expired. Please retry.");
                }
            });

            // Set up Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isGuest = user.isAnonymous;
                    
                    if (isGuest) {
                        setGuestMode(true);
                        setView('app');
                        console.log("User is guest:", userId);
                    } else {
                        setGuestMode(false);
                        setProfileDisplay();
                        setView('app');
                        console.log("User authenticated:", userId);

                        // Update last active status in Firestore
                        try {
                            // Path: artifacts/appId/users/userId/settings/app_state
                            await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'settings', 'app_state'), {
                                last_active: new Date().toISOString()
                            }, { merge: true });
                        } catch (e) {
                            console.error("Firestore write failed (app_state):", e);
                        }
                    }
                    
                } else {
                    userId = crypto.randomUUID();
                    isGuest = false;
                    console.log("User signed out or anonymous. Showing Auth UI.");
                    setView('auth');
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setView('auth'); 
        }

        // --- AUTH HANDLERS: EMAIL/PASSWORD ---
        
        toggleAuthBtn.addEventListener('click', () => {
            isSigningUp = !isSigningUp;
            hideAuthError();
            
            if (isSigningUp) {
                authTitleText.textContent = "Sign Up and get started! ü•≥";
                authSubmitBtn.textContent = "Sign Up";
                toggleAuthBtn.textContent = "Already have an account? Sign In";
            } else {
                authTitleText.textContent = "Sign In to continue, bro.";
                authSubmitBtn.textContent = "Sign In";
                toggleAuthBtn.textContent = "Don't have an account? Sign Up";
            }
        });

        guestLoginBtn.addEventListener('click', async () => {
            try {
                await signInAnonymously(auth);
                // Auth state listener handles view change
            } catch (error) {
                console.error("Guest login failed:", error);
                showAuthError("Failed to sign in as guest. Try a regular sign-in instead.");
            }
        });

        emailAuthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAuthError();
            
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            if (password.length < 6) {
                showAuthError("Password must be at least 6 characters long, dude.");
                return;
            }

            authSubmitBtn.disabled = true;
            authSubmitBtn.textContent = isSigningUp ? "Signing Up..." : "Signing In...";

            try {
                let userCredential;
                if (isSigningUp) {
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // Store user profile data
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), {
                        email: user.email,
                        created: new Date().toISOString(),
                        app: appId
                    });

                } else {
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error("Email/Password Auth Error:", error);
                let message = "Authentication failed. Check your email and password.";
                if (error.code === 'auth/email-already-in-use') {
                    message = "This email is already registered. Try signing in!";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    message = "Invalid credentials, bro. Try again.";
                }
                showAuthError(message);
            } finally {
                authSubmitBtn.disabled = false;
                authSubmitBtn.textContent = isSigningUp ? "Sign Up" : "Sign In";
            }
        });

        // --- AUTH HANDLERS: PHONE/OTP ---

        function setPhoneModeUI(isOtpPhase) {
            if (isOtpPhase) {
                otpInputGroup.classList.remove('hidden');
                phoneNumberInput.disabled = true;
                phoneSubmitBtn.textContent = "Verify Code";
            } else {
                otpInputGroup.classList.add('hidden');
                phoneNumberInput.disabled = false;
                phoneSubmitBtn.textContent = "Request OTP";
                authOtpInput.value = '';
                verificationId = null;
            }
        }

        phoneAuthForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAuthError();
            
            const phoneNumber = phoneNumberInput.value.trim();
            phoneSubmitBtn.disabled = true;

            if (!verificationId) {
                // PHASE 1: Request OTP
                if (!phoneNumber) {
                    showAuthError("Dude, enter a phone number first (+CCXXXXXXXXXX).");
                    phoneSubmitBtn.disabled = false;
                    return;
                }
                
                phoneSubmitBtn.textContent = "Sending...";

                try {
                    // Send OTP using the initialized invisible reCAPTCHA verifier
                    const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
                    verificationId = confirmationResult; // Store for the next phase
                    
                    setPhoneModeUI(true);
                    showAuthError(`OTP sent to ${phoneNumber}! Enter the code below.`);
                    authOtpInput.focus();

                } catch (error) {
                    console.error("Phone Auth Request Error:", error);
                    let message = "Failed to send OTP. Check the phone number format (+CCXXXXXXX) and your Firebase Phone Auth settings.";
                    if (error.code === 'auth/invalid-phone-number') {
                        message = "That phone number format looks whack. Use +CCXXXXXXXXXX.";
                    }
                    showAuthError(message);
                    setPhoneModeUI(false);
                }
            } else {
                // PHASE 2: Verify OTP
                const otpCode = authOtpInput.value.trim();
                if (!otpCode) {
                    showAuthError("Yo, enter the 6-digit OTP code.");
                    phoneSubmitBtn.disabled = false;
                    return;
                }

                phoneSubmitBtn.textContent = "Verifying...";

                try {
                    await verificationId.confirm(otpCode);
                    // Successful login handled by onAuthStateChanged
                    
                    // Optional: Store phone number in custom profile document
                    await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'profile', 'info'), {
                        phoneNumber: auth.currentUser.phoneNumber,
                        created: new Date().toISOString(),
                        app: appId
                    }, { merge: true });

                } catch (error) {
                    console.error("Phone Auth Verification Error:", error);
                    let message = "Verification failed. Wrong code or session expired. Try requesting a new OTP.";
                    if (error.code === 'auth/invalid-verification-code') {
                         message = "That code is invalid, bro. Check it and try again.";
                    }
                    showAuthError(message);
                    // Reset to Phase 1 after failure
                    setPhoneModeUI(false); 
                }
            }
            phoneSubmitBtn.disabled = false;
        });

        // --- AUTH MODE TOGGLE ---

        modeEmailBtn.addEventListener('click', () => {
            if (authMode !== 'email') {
                authMode = 'email';
                modeEmailBtn.classList.add('text-primary', 'border-primary', 'font-semibold');
                modePhoneBtn.classList.remove('text-primary', 'border-primary', 'font-semibold');
                modePhoneBtn.classList.add('text-subtle-text', 'border-transparent', 'hover:border-primary');
                
                emailAuthContainer.classList.remove('hidden');
                phoneAuthContainer.classList.add('hidden');
                hideAuthError();
                setPhoneModeUI(false); // Reset phone flow
            }
        });

        modePhoneBtn.addEventListener('click', () => {
            if (authMode !== 'phone') {
                authMode = 'phone';
                modePhoneBtn.classList.add('text-primary', 'border-primary', 'font-semibold');
                modeEmailBtn.classList.remove('text-primary', 'border-primary', 'font-semibold');
                modeEmailBtn.classList.add('text-subtle-text', 'border-transparent', 'hover:border-primary');

                phoneAuthContainer.classList.remove('hidden');
                emailAuthContainer.classList.add('hidden');
                hideAuthError();
            }
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign out error:", error);
                showError("Sign Out Failed!", "Something went wrong logging you out.");
            }
        });

        // --- ACCOUNT SETTINGS LOGIC ---
        
        settingsBtn.addEventListener('click', () => setView('settings'));
        closeSettingsBtn.addEventListener('click', () => setView('app'));

        async function loadProfileDetails() {
            if (!auth.currentUser || auth.currentUser.isAnonymous) return;
            
            profileNameInput.value = auth.currentUser.displayName || '';
            newEmailInput.placeholder = auth.currentUser.email || 'N/A';
        }

        /**
         * Re-authenticates the user using their password, required for sensitive operations.
         * @param {string} password The user's current password.
         * @returns {Promise<void>}
         */
        async function reauthenticateUser(password) {
            const user = auth.currentUser;
            if (!user.email) {
                throw new Error("Phone/Guest user re-authentication not supported via password.");
            }
            
            const credential = EmailAuthProvider.credential(user.email, password);
            await reauthenticateWithCredential(user, credential);
        }

        // 1. Update Profile Name
        updateProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideSettingsMessage();
            const displayName = profileNameInput.value.trim();
            
            if (displayName === auth.currentUser.displayName) {
                showSettingsMessage("Dude, your display name is already set to that!", false);
                return;
            }

            try {
                await updateProfile(auth.currentUser, { displayName });
                
                // Update Firestore profile document
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'info'), { 
                    displayName: displayName 
                }, { merge: true });
                
                setProfileDisplay();
                showSettingsMessage("Profile name updated successfully! üéâ");
            } catch (error) {
                console.error("Update profile error:", error);
                showSettingsMessage(`What the fuck? Name update failed. Details: ${error.message}`, false);
            }
        });
        
        // 2. Update Email
        updateEmailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideSettingsMessage();
            const newEmail = newEmailInput.value.trim();
            const currentPassword = currentPasswordEmailInput.value;

            if (auth.currentUser.email === newEmail) {
                 showSettingsMessage("Your email is already set to that, bro.", false);
                 return;
            }

            try {
                await reauthenticateUser(currentPassword);
                await updateEmail(auth.currentUser, newEmail);

                 // Update Firestore profile document
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'profile', 'info'), { 
                    email: newEmail 
                }, { merge: true });

                showSettingsMessage("Email updated successfully! Please re-login with your new email. Signing you out...", true);
                setTimeout(() => signOut(auth), 2000);
            } catch (error) {
                console.error("Update email error:", error);
                showSettingsMessage(`Email update failed. Check your password and the new email format. Details: ${error.message}`, false);
            } finally {
                currentPasswordEmailInput.value = '';
            }
        });
        
        // 3. Update Password
        updatePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideSettingsMessage();
            const newPassword = newPasswordInput.value;
            const currentPassword = currentPasswordPassInput.value;
            
            if (newPassword.length < 6) {
                showSettingsMessage("New password must be at least 6 characters long, dude.", false);
                return;
            }

            try {
                await reauthenticateUser(currentPassword);
                await updatePassword(auth.currentUser, newPassword);
                
                showSettingsMessage("Password updated successfully! You're super secure now! üí™", true);
            } catch (error) {
                console.error("Update password error:", error);
                showSettingsMessage(`Password update failed. Check your current password. Details: ${error.message}`, false);
            } finally {
                currentPasswordPassInput.value = '';
                newPasswordInput.value = '';
            }
        });
        
        // 4. Delete Account
        deleteAccountForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideSettingsMessage();
            const password = deletePasswordInput.value;

            // Using custom modal is required, but since this is a self-contained file, using confirm() 
            // as a temporary substitute until a proper modal UI is added.
            if (!confirm("Are you absolutely sure, bro? This permanently deletes ALL your data and account!")) {
                deletePasswordInput.value = '';
                return;
            }

            try {
                await reauthenticateUser(password);
                await deleteUser(auth.currentUser);
                
                // Firestore data cleanup is handled by security rules on the backend, 
                // but we rely on Firebase Auth to handle the user session.
                showSettingsMessage("Account permanently deleted! See ya!", true);
            } catch (error) {
                console.error("Delete account error:", error);
                showSettingsMessage(`Account deletion failed. Check your current password. Details: ${error.message}`, false);
            } finally {
                deletePasswordInput.value = '';
            }
        });
        
        // --- GEMINI API INTEGRATION ---

        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        // üõë PASTE YOUR KEY HERE TO FIX 403 ERROR üõë
        const API_KEY = "AIzaSyBpTa0-Xs4owjDg24y9stHEae8FvkZ8cns"; 
        
        // Exponential backoff for API calls
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Throw error if response status is not OK (e.g., 429, 500)
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error("Max retries reached. Failing request.", error);
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Retry ${i + 1} failed. Retrying in ${Math.round(delay / 1000)}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        /**
         * Calls the Gemini API for text transformation.
         * @param {string} userQuery The text to process.
         * @param {string} systemInstruction The persona and task for the model.
         * @returns {Promise<string>} The generated text.
         */
        async function callGeminiAPI(userQuery, systemInstruction) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetchWithRetry(apiUrl, options);
                const result = await response.json();

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) {
                     // Check if there is an error message from the API
                     const apiError = result?.error?.message || "Unknown error from Gemini API.";
                     throw new Error(`API response was empty or malformed. Details: ${apiError}`);
                }

                return text;

            } catch (error) {
                console.error("Gemini API call failed:", error);
                throw new Error(`Failed to process text. Details: ${error.message}`);
            }
        }

        // --- ACTION HANDLERS ---

        /**
         * Handles all text transformation actions.
         * @param {string} instruction The specific action (e.g., 'grammar', 'paraphrase').
         */
        async function handleAction(instruction) {
            hideError();
            const input = inputTextarea.value.trim();
            if (!input) {
                showError("Hold up!", "Please enter some text before running an operation, bro.");
                return;
            }

            // Guest mode restriction
            if (isGuest && instruction !== 'grammar') {
                 showError("Access Denied!", "As a Guest, you can only use the Grammar Check feature. Sign Up to unlock Paraphrase and Hinglish!");
                 return;
            }


            let systemPrompt;
            let actionText;

            switch (instruction) {
                case 'grammar':
                    actionText = 'Grammar Check';
                    systemPrompt = "You are an expert copy editor and language model. Your task is to correct any grammatical errors, spelling mistakes, and awkward phrasing in the user's text. Maintain the original meaning and adopt a professional yet casual, friendly tone suitable for customer interactions.";
                    break;
                case 'paraphrase':
                    actionText = 'Paraphrase';
                    systemPrompt = "You are an expert rewriter. Your task is to paraphrase the user's text, making it sound fresh and clear while maintaining the professional yet casual, friendly tone suitable for customer interactions. The output should be the full, rephrased text.";
                    break;
                case 'hinglish':
                    actionText = 'Hinglish Translation';
                    systemPrompt = "You are an expert translator specializing in Hinglish (a mixture of Hindi and English) conversation. Translate the user's English text into a natural-sounding Hinglish conversational style. Retain the original meaning and maintain a professional yet casual, friendly tone. The output should be the full translated text.";
                    break;
                default:
                    return;
            }

            outputTextarea.value = ''; // Clear previous output
            showStatus(`Running ${actionText}...`);

            try {
                const result = await callGeminiAPI(input, systemPrompt);
                outputTextarea.value = result;
                hideStatus();
                
                // Save result to firestore for authenticated users only
                if (db && userId && auth.currentUser && !isGuest) {
                    // Path: artifacts/appId/users/userId/operations/new_doc_id
                    await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'operations', `op_${Date.now()}`), {
                        action: instruction,
                        input: input,
                        output: result,
                        timestamp: new Date().toISOString()
                    });
                }
            } catch (error) {
                hideStatus();
                showError(`What the heck? ${actionText} failed!`, error.message);
            }
        }

        // --- VOICE INPUT LOGIC (Web Speech API) ---

        let recognition = null;
        let isRecording = false;

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false; // Stop after a single, continuous input
            recognition.lang = 'en-US';
            recognition.interimResults = true; // Show results as they come in

            recognition.onstart = () => {
                isRecording = true;
                recordingIndicator.classList.remove('hidden');
                voiceInputBtn.classList.add('bg-red-500', 'text-white', 'rounded-full');
                showStatus("Listening... Speak clearly now, dude!");
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        inputTextarea.value += (inputTextarea.value ? ' ' : '') + transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error("Voice Recognition Error:", event.error);
                hideStatus();
                isRecording = false;
                recordingIndicator.classList.add('hidden');
                voiceInputBtn.classList.remove('bg-red-500', 'text-white', 'rounded-full');

                let detail = "Check your browser's microphone permissions. The app needs HTTPS or localhost to work properly. Reload the page after allowing access.";
                if (event.error === 'not-allowed') {
                    showError("Microphone Access Blocked! üõë", detail);
                } else if (event.error === 'no-speech') {
                    showError("No Speech Detected!", "Couldn't hear anything. Try again.");
                } else {
                    showError(`Voice Error: ${event.error}`, detail);
                }
            };

            recognition.onend = () => {
                isRecording = false;
                recordingIndicator.classList.add('hidden');
                voiceInputBtn.classList.remove('bg-red-500', 'text-white', 'rounded-full');
                if (!errorBox.classList.contains('hidden')) return; 
                hideStatus();
            };

            voiceInputBtn.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    hideError();
                    inputTextarea.focus();
                    recognition.start();
                }
            });

        } else {
            voiceInputBtn.disabled = true;
            voiceInputBtn.title = "Browser does not support Speech Recognition API.";
            voiceInputBtn.classList.add('opacity-30', 'cursor-not-allowed');
            setTimeout(() => {
                showError("Browser limitation:", "This browser doesn't support the required Speech Recognition API. Sorry, dude!");
            }, 500);
        }

        // --- GENERAL EVENT LISTENERS ---

        grammarBtn.addEventListener('click', () => handleAction('grammar'));
        paraphraseBtn.addEventListener('click', () => handleAction('paraphrase'));
        hinglishBtn.addEventListener('click', () => handleAction('hinglish'));
        
        // Enter key listener for Grammar Check
        inputTextarea.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Prevent new line in textarea
                handleAction('grammar');
            }
        });
        
    </script>
</body>
</html>
